# Claude Memory - MCP Server Implementation Guide

## Table of Contents
1. [Overview](#overview)
2. [Architecture](#architecture)
3. [How MCP Servers Work](#how-mcp-servers-work)
4. [Prerequisites](#prerequisites)
5. [Installation](#installation)
6. [Configuration](#configuration)
7. [Testing](#testing)
8. [Usage in Claude Code](#usage-in-claude-code)
9. [Troubleshooting](#troubleshooting)
10. [How It All Works Together](#how-it-all-works-together)

---

## Overview

The **Claude Memory MCP Server** provides three powerful tools to Claude Code:

| Tool | Description | Use Case |
|------|-------------|----------|
| `search_memory` | Semantic search through past conversations | Find relevant previous work, decisions, solutions |
| `get_timeline` | Chronological history for a project | See what was done and when |
| `get_snapshot` | Detailed view of a specific snapshot | Inspect full context of past work |

### What Makes This Special

- ðŸ§  **Semantic Search**: Uses AI embeddings to find relevant conversations by *meaning*, not just keywords
- ðŸ“Š **AI Summaries**: Each snapshot has a detailed narrative summary generated by llama3.2
- ðŸ’¾ **Zero Context Cost**: Past conversations don't consume your context window
- ðŸš€ **Fast**: Vector similarity search returns results in <100ms

---

## Architecture

### System Components

\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Docker Containers                            â”‚
â”‚                   (Always Running - 24/7)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   PostgreSQL     â”‚  â”‚    Context       â”‚  â”‚    Ollama     â”‚ â”‚
â”‚  â”‚   + pgvector     â”‚  â”‚   Processor      â”‚  â”‚  (llama3.2)   â”‚ â”‚
â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚               â”‚ â”‚
â”‚  â”‚  Port: 5435      â”‚  â”‚  Port: 3200      â”‚  â”‚  Port: 11434  â”‚ â”‚
â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚               â”‚ â”‚
â”‚  â”‚  â€¢ Stores        â”‚  â”‚  â€¢ Captures      â”‚  â”‚  â€¢ Generates  â”‚ â”‚
â”‚  â”‚    snapshots     â”‚  â”‚    conversations â”‚  â”‚    summaries  â”‚ â”‚
â”‚  â”‚  â€¢ Vector search â”‚  â”‚  â€¢ Generates     â”‚  â”‚               â”‚ â”‚
â”‚  â”‚    with HNSW     â”‚  â”‚    embeddings    â”‚  â”‚               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MCP Server Process                            â”‚
â”‚              (Invoked by Claude Code on demand)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  MCP Server (Node.js)                                      â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  â€¢ Runs locally on your machine                           â”‚ â”‚
â”‚  â”‚  â€¢ Started automatically when Claude Code launches        â”‚ â”‚
â”‚  â”‚  â€¢ Communicates via stdio (standard input/output)         â”‚ â”‚
â”‚  â”‚  â€¢ Connects to PostgreSQL on localhost:5435               â”‚ â”‚
â”‚  â”‚  â€¢ Connects to Processor on localhost:3200                â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  Tools: search_memory, get_timeline, get_snapshot         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

### Why MCP Server Runs Locally (Not in Docker)

**MCP servers use stdio (standard input/output) protocol:**
- Claude Code launches the MCP server as a child process
- Communication happens through stdin/stdout pipes
- This is the official MCP specification from Anthropic
- Docker containers can't maintain stdio connections properly

**Benefits of local execution:**
- âœ… Only runs when Claude Code needs it (saves resources)
- âœ… Direct stdio communication (faster, no HTTP overhead)
- âœ… Standard MCP pattern (works with all MCP-compatible tools)
- âœ… Easier debugging (see logs in Claude Code)

**Docker containers still handle:**
- âœ… Database (persistent storage, always available)
- âœ… Processor (background capture, embedding generation)
- âœ… Ollama (AI model for summarization)

---

## How MCP Servers Work

### The Model Context Protocol (MCP)

MCP is Anthropic's standard for extending Claude with custom tools and data sources.

#### Communication Flow

\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         stdio          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  â”‚             â”‚
â”‚ Claude Code â”‚                        â”‚ MCP Server  â”‚
â”‚             â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                                       â”‚
      â”‚  "Search for database                â”‚
      â”‚   migration conversations"            â”‚
      â”‚                                       â–¼
      â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                              â”‚  1. Generate    â”‚
      â”‚                              â”‚     embedding   â”‚
      â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                                       â–¼
      â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                              â”‚  2. Vector      â”‚
      â”‚                              â”‚     similarity  â”‚
      â”‚                              â”‚     search      â”‚
      â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                                       â”‚
      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
      â”‚  â”‚ Found 3 snapshots:      â”‚ <â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚  â”‚ - PostgreSQL migration  â”‚
      â”‚  â”‚ - Database upgrade      â”‚
      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–¼
   Claude uses this context
\`\`\`

---

## Prerequisites

### System Requirements

1. **Node.js** (v18 or higher)
   \`\`\`bash
   node --version  # Should be v18+
   \`\`\`

2. **Docker & Docker Compose**
   \`\`\`bash
   docker --version
   docker compose version
   \`\`\`

3. **Claude Code CLI**
   - Must be installed and working

### Running Services

Before configuring MCP, ensure the Docker services are running:

\`\`\`bash
cd /path/to/claude-memory
docker compose up -d
\`\`\`

Verify all services are healthy:
\`\`\`bash
docker compose ps
\`\`\`

---

## Installation

### Step 1: Install MCP Server Dependencies

\`\`\`bash
cd /path/to/claude-memory/mcp-server
npm install
\`\`\`

### Step 2: Get Your Database Password

\`\`\`bash
cd /path/to/claude-memory
cat .env | grep CONTEXT_DB_PASSWORD
\`\`\`

Note this password - you'll need it for configuration.

### Step 3: Test MCP Server Locally

\`\`\`bash
# Set environment variables
export DATABASE_URL="postgresql://memory_admin:YOUR_PASSWORD@localhost:5435/claude_memory"
export PROCESSOR_URL="http://localhost:3200"

# Run the server
node mcp-server/src/server.js
\`\`\`

You should see:
\`\`\`
ðŸ§  Claude Memory MCP Server started
ðŸ“ Database: postgresql://memory_admin:****@localhost:5435/claude_memory
ðŸ”§ Tools: search_memory, get_timeline, get_snapshot
\`\`\`

Press Ctrl+C to stop.

---

## Configuration

### Claude Code MCP Configuration

#### Configuration File Location

- **macOS**: \`~/.claude/config.json\`
- **Linux**: \`~/.config/claude/config.json\`
- **Windows**: \`%APPDATA%\\Claude\\config.json\`

#### Add Claude Memory MCP Server

Edit your Claude Code config file and add:

\`\`\`json
{
  "mcpServers": {
    "claude-memory": {
      "command": "node",
      "args": [
        "/ABSOLUTE/PATH/TO/claude-memory/mcp-server/src/server.js"
      ],
      "env": {
        "DATABASE_URL": "postgresql://memory_admin:YOUR_PASSWORD@localhost:5435/claude_memory",
        "PROCESSOR_URL": "http://localhost:3200",
        "EMBEDDING_MODEL": "sentence-transformers/all-MiniLM-L6-v2"
      }
    }
  }
}
\`\`\`

**Important:**
- Replace \`/ABSOLUTE/PATH/TO/claude-memory\` with actual path
- Replace \`YOUR_PASSWORD\` with password from .env
- Use **absolute paths** (not ~/ or ./)

#### Example

If claude-memory is at \`/Users/john/projects/claude-memory\`:

\`\`\`json
{
  "mcpServers": {
    "claude-memory": {
      "command": "node",
      "args": [
        "/Users/john/projects/claude-memory/mcp-server/src/server.js"
      ],
      "env": {
        "DATABASE_URL": "postgresql://memory_admin:secure_pass_123@localhost:5435/claude_memory",
        "PROCESSOR_URL": "http://localhost:3200",
        "EMBEDDING_MODEL": "sentence-transformers/all-MiniLM-L6-v2"
      }
    }
  }
}
\`\`\`

---

## Testing

### Test Services

\`\`\`bash
# Database
docker exec claude-context-db pg_isready -U memory_admin -d claude_memory

# Processor
curl http://localhost:3200/health

# Ollama
curl http://localhost:11434/api/tags
\`\`\`

### Test in Claude Code

Start Claude Code:
\`\`\`bash
claude
\`\`\`

Try asking:
- "Search my memory for database work"
- "Show me the timeline for this project"
- "What did we work on regarding authentication?"

Claude Code will automatically use the tools!

---

## Usage in Claude Code

### Available Tools

#### 1. search_memory

Find relevant past conversations using semantic similarity.

**Example prompts:**
- "What have we worked on related to database migrations?"
- "Find previous conversations about authentication"
- "Have we dealt with Docker networking before?"

**Output example:**
\`\`\`
ðŸ“‹ Snapshot #14
ðŸ“ Project: /test/postgres-migration
ðŸ“… Date: 12/14/2025, 9:46 PM
ðŸ”– Tags: postgresql, database, migration
ðŸ“„ Files: scripts/migrate_pg.sh

ðŸ“Š Summary:
Implemented PostgreSQL migration from v12 to v15 using pg_dump/pg_restore...
\`\`\`

#### 2. get_timeline

Get chronological history of work on a project.

**Example prompts:**
- "Show me the timeline for this project"
- "What have we done over time?"

#### 3. get_snapshot

Get detailed information about a specific snapshot.

**Example prompts:**
- "Show me details for snapshot #14"
- "What was in snapshot 23?"

---

## Troubleshooting

### MCP Server Not Found

**Solution:**
1. Check config file: \`cat ~/.claude/config.json\`
2. Verify JSON syntax is valid
3. Check paths are absolute (no ~/ or ./)
4. Restart Claude Code

### Database Connection Errors

**Solution:**
1. Verify containers running: \`docker compose ps\`
2. Check database: \`docker exec claude-context-db pg_isready\`
3. Verify password matches .env
4. Try \`127.0.0.1\` instead of \`localhost\`

### No Search Results

**Solution:**
1. Check snapshots exist:
   \`\`\`bash
   docker exec claude-context-db psql -U memory_admin -d claude_memory \\
     -c "SELECT COUNT(*) FROM context_snapshots;"
   \`\`\`
2. Try broader search terms

---

## How It All Works Together

### Conversation Capture (Background)

\`\`\`
You work with Claude Code
         â†“
POST /capture â†’ Processor (port 3200)
         â†“
1. Load conversation
2. Extract metadata
3. Generate AI summary (Ollama)
4. Generate embedding (Python)
5. Store in PostgreSQL
         â†“
Snapshot stored
\`\`\`

### Memory Search (On Demand)

\`\`\`
You: "What did we do about migrations?"
         â†“
Claude Code calls search_memory
         â†“
MCP Server:
  1. Generate embedding for query
  2. Vector similarity search
  3. Return top matches
         â†“
Claude Code uses context to answer
\`\`\`

### Full System

\`\`\`
YOU â†â†’ CLAUDE CODE
         â†“
   MCP SERVER (local)
         â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  DB    â”‚ Processorâ”‚ Ollama â”‚
   â”‚ (5435) â”‚  (3200)  â”‚(11434) â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

---

## Performance

### Storage

Each snapshot: ~5 KB
- 1,000 snapshots = 5 MB
- 10,000 snapshots = 50 MB
- 100,000 snapshots = 500 MB

### Speed

- Capture: 10-25 seconds (AI summary)
- Search: <100ms (vector index)
- Timeline: <50ms
- Snapshot retrieval: <10ms

---

## Summary

**What you have:**
- ðŸ§  AI-powered memory for Claude Code
- ðŸ” Semantic search through all past work
- ðŸ“Š Automatic AI summaries
- ðŸ’¾ Zero context window cost
- ðŸš€ Fast vector search

**How to use:**
1. Work with Claude Code normally
2. Conversations captured automatically
3. Ask about past work naturally
4. Claude Code searches memory automatically

**That's it!** The system works invisibly, preserving all context forever.

---

*Last updated: 2025-12-14*
